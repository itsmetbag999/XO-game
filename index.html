<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>‚ùå‚≠ï XO Pro ‚Äî Farcaster Mini App</title>
<style>
  :root { color-scheme: dark; }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    background: linear-gradient(135deg, #0a0e13 0%, #1a1f2e 100%);
    color: #e7ecf0;
    font-family: system-ui, -apple-system, "Segoe UI", sans-serif;
    display: flex; flex-direction: column; align-items: center;
    min-height: 100dvh; padding: 20px;
  }
  .wrap { width: min(900px, 96vw); position: relative; }
  .card { background: #12171b; border: 1px solid #1f2a32; border-radius: 14px; padding: 20px; box-shadow: 0 10px 30px rgba(0,0,0,.35); }
  .overlay { position: fixed; inset: 0; display: grid; place-items: center; background: rgba(8,11,14,.85); backdrop-filter: blur(4px); padding: 16px; z-index: 100; }
  .hidden { display: none !important; }

  h1 { font-size: 28px; font-weight: 900; margin-bottom: 12px; text-shadow: 0 2px 10px rgba(56,189,248,0.5); }
  .muted { color: #9aa7b1; font-size: 14px; line-height: 1.4; margin-bottom: 16px; }

  .btn-primary{ padding:14px 28px; background:linear-gradient(135deg,#ff8c42,#ff6b1a); color:#fff; border:none; border-radius:12px; font-weight:900; font-size:16px; cursor:pointer; box-shadow:0 6px 20px rgba(255,107,26,0.4); transition:all .2s; text-transform:uppercase; letter-spacing:.5px; }
  .btn-primary:hover:not(:disabled){ transform:translateY(-2px); box-shadow:0 8px 25px rgba(255,107,26,.5); }
  .btn-primary:disabled{ opacity:.6; cursor:not-allowed; }

  .btn-secondary{ padding:12px 24px; background:linear-gradient(135deg,#38bdf8,#34d399); color:#0a1929; border:none; border-radius:10px; font-weight:900; font-size:14px; cursor:pointer; box-shadow:0 4px 15px rgba(56,189,248,.3); transition:all .2s; letter-spacing:.5px; text-transform:uppercase; }
  .btn-reset{ background:linear-gradient(135deg,#f43f5e,#f59e0b); }

  #status{ margin-top:15px; font-size:13px; line-height:1.5; background:#0f151a; border:1px solid #1f2a32; border-radius:10px; padding:12px; }
  #status b{ color:#cde7d8; } #status .ok{ color:#4ade80; } #status .warn{ color:#fbbf24; } #status .err{ color:#f87171; } #status a{ color:#86c6ff; text-decoration:none; }

  /* HUD + Board */
  .hud { display:flex; gap:12px; flex-wrap:wrap; align-items:center; justify-content:space-between; margin: 10px 0 16px; }
  .chip { background:#0f1418; border:1px solid #1f2a32; border-radius:10px; padding:8px 12px; font-weight:800; font-size:13px; }
  .timer-chip { background:#1a0f0f; border:2px solid #f59e0b; }
  .grid { display:grid; grid-template-columns: repeat(3, 110px); gap:10px; justify-content:center; }
  .cell { position:relative; width:110px; height:110px; display:grid; place-items:center; font-size:64px; font-weight:900; background:#0d1117; border:3px solid #1f2937; border-radius:14px; cursor:pointer; transition:transform .12s, filter .12s; }
  .cell:hover{ transform:translateY(-1px); filter:brightness(1.06); }
  .cell:disabled{ opacity:.8; cursor:default; }
  .mark.x{ color:#60a5fa; text-shadow:0 6px 20px rgba(96,165,250,.25); }
  .mark.o{ color:#f472b6; text-shadow:0 6px 20px rgba(244,114,182,.25); }
  .win-line{ position:absolute; inset:0; border-radius:14px; box-shadow:0 0 0 3px #fbbf24 inset; opacity:0; transform:scale(.98); transition:opacity .2s, transform .2s; }
  .cell.win .win-line{ opacity:1; transform:scale(1); }

  .controls { display:flex; gap:10px; flex-wrap:wrap; justify-content:center; margin-top:14px; }
  .info { color:#94a3b8; font-size:13px; }

  @media (max-width: 720px) { .grid{ grid-template-columns:repeat(3, 90px);} .cell{ width:90px; height:90px; font-size:54px;} }
</style>
</head>
<body>
  <div class="wrap">
    <!-- Pay Overlay -->
    <div id="intro-overlay" class="overlay">
      <div class="card" role="dialog" aria-modal="true">
        <h1>‚ùå‚≠ï Play XO Pro</h1>
        <p class="muted">A small Base transfer is required to start playing against CPU (5-second timed rounds).</p>
        <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap;">
          <div class="muted" style="font-size:12px;">Edit recipient/amount in code if needed.</div>
          <button id="play" class="btn-primary">üí∞ Pay & Play</button>
        </div>
        <div id="status" class="hidden"></div>
      </div>
    </div>

    <!-- Game Card -->
    <div class="card">
      <div class="hud">
        <div class="chip">Turn: <span id="turnBadge">X</span></div>
        <div class="chip timer-chip">‚è±Ô∏è Time: <span id="timer">5.0</span>s</div>
        <div class="chip">Score X: <span id="scoreX">0</span></div>
        <div class="chip">Score O: <span id="scoreO">0</span></div>
        <div class="chip">Mode: CPU</div>
        <div class="chip">Paid: <span id="paid">No</span></div>
      </div>

      <div class="grid" id="board" role="grid" aria-label="XO board"></div>

      <div class="controls">
        <button id="resetRound" class="btn-secondary">üí∞ Pay & Reset Round</button>
        <button id="resetMatch" class="btn-secondary btn-reset">üí∞ Pay & Reset Match</button>
      </div>

      <p class="muted" style="margin-top:12px">‚ö° Each round auto-ends after 5 seconds! X always starts. First to 3 round wins takes the match.</p>
    </div>
  </div>

<script type="module">
import { sdk } from 'https://esm.sh/@farcaster/miniapp-sdk';
sdk.actions.ready();

/* ===== CONFIG ‚Äî set these ===== */
const USE_BASE_SEPOLIA = false; // true = testnet
const RECIPIENT = "0x49d31B3dDEd689c0FD3168307Cb1f69F5c680f06"; // <- your address
const AMOUNT_ETH = "0.00001"; // <- your fee
const ROUND_TIME = 5; // seconds per round

const BASE_MAINNET = { chainId: "0x2105", explorer: "https://basescan.org/tx/" };
const BASE_SEPOLIA = { chainId: "0x14a34", explorer: "https://sepolia.basescan.org/tx/" };
const TARGET = USE_BASE_SEPOLIA ? BASE_SEPOLIA : BASE_MAINNET;

/* ===== DOM ===== */
const statusEl = document.getElementById('status');
const playBtn = document.getElementById('play');
const paidEl = document.getElementById('paid');
const boardEl = document.getElementById('board');
const turnBadge = document.getElementById('turnBadge');
const timerEl = document.getElementById('timer');
const scoreXEl = document.getElementById('scoreX');
const scoreOEl = document.getElementById('scoreO');
const resetRoundBtn = document.getElementById('resetRound');
const resetMatchBtn = document.getElementById('resetMatch');

const showStatus = () => statusEl.classList.remove('hidden');
const addLine = html => { showStatus(); statusEl.insertAdjacentHTML('beforeend', `<div>${html}</div>`); };
const clearStatus = () => statusEl.innerHTML = '';
const disable = (el, yes=true) => { if (el) el.disabled = yes; };

/* ===== Wallet Helpers ===== */
function parseEther(x){ const [w,f=""] = String(x).split('.'); const frac=(f+'0'.repeat(18)).slice(0,18); return '0x'+(BigInt(w)*10n**18n + BigInt(frac)).toString(16); }
async function getProvider(){ try{ const p = await sdk.wallet.getEthereumProvider(); if (p) return p; }catch{} return window.ethereum??null; }
async function ensureChain(provider, chainId){
  const current=(await provider.request({method:'eth_chainId'}))?.toLowerCase();
  if(current===chainId.toLowerCase()) return;
  try{ await provider.request({method:'wallet_switchEthereumChain', params:[{chainId}]}); }
  catch(e){
    if(e?.code===4902){
      await provider.request({method:'wallet_addEthereumChain', params:[{chainId}]});
      await provider.request({method:'wallet_switchEthereumChain', params:[{chainId}]});
    } else { throw e; }
  }
}
async function requiredPayment(){
  clearStatus();
  addLine(`<b>Step 1:</b> Locating wallet provider‚Ä¶`);
  const provider=await getProvider();
  if(!provider){ addLine(`<span class="err">No wallet available.</span> Open in Farcaster or enable a wallet.`); throw new Error('NO_PROVIDER'); }
  addLine(`<span class="ok">Provider ready.</span>`);
  addLine(`<b>Step 2:</b> Requesting accounts‚Ä¶`);
  const [from] = await provider.request({ method:'eth_requestAccounts' });
  addLine(`<span class="ok">Account: ${from.slice(0,6)}‚Ä¶${from.slice(-4)}</span>`);
  addLine(`<b>Step 3:</b> Switching to Base${USE_BASE_SEPOLIA?' Sepolia':''}‚Ä¶`);
  await ensureChain(provider, TARGET.chainId);
  addLine(`<span class="ok">On Base${USE_BASE_SEPOLIA?' Sepolia':''}.</span>`);
  addLine(`<b>Step 4:</b> Sending ${AMOUNT_ETH} ETH to ${RECIPIENT.slice(0,6)}‚Ä¶${RECIPIENT.slice(-4)}‚Ä¶`);
  const hash = await provider.request({
    method:'eth_sendTransaction',
    params:[{ from, to: RECIPIENT, value: parseEther(AMOUNT_ETH) }]
  });
  addLine(`<span class="ok">TX sent.</span> <a target="_blank" rel="noopener" href="${TARGET.explorer}${hash}">View on Basescan</a>`);
  return hash;
}
async function payThen(action, triggerBtn){
  try{ disable(triggerBtn,true); await requiredPayment(); await action(); }
  catch(e){ console.warn('Payment gate blocked action:', e); addLine(`<span class="warn">Payment required. Please try again.</span>`); }
  finally{ disable(triggerBtn,false); }
}

/* ===== XO Game (CPU only, timed) ===== */
const WIN_LINES = [
  [0,1,2],[3,4,5],[6,7,8],
  [0,3,6],[1,4,7],[2,5,8],
  [0,4,8],[2,4,6]
];
let cells = [];
let board = Array(9).fill('');
let turn = 'X';
let scores = { X:0, O:0 };
let roundOver = false;
let paid = false;
let roundTimer = null;
let timeLeft = ROUND_TIME;

function updatePaid(v){
  paid = v; 
  paidEl.textContent = v ? 'Yes' : 'No';
}

function initBoard(){
  boardEl.innerHTML = '';
  cells = [];
  for (let i=0;i<9;i++){
    const btn=document.createElement('button');
    btn.className='cell'; btn.dataset.index=i; btn.setAttribute('role','gridcell');
    const mark=document.createElement('span'); mark.className='mark'; btn.appendChild(mark);
    const winLine=document.createElement('span'); winLine.className='win-line'; btn.appendChild(winLine);
    btn.addEventListener('click', onCellClick);
    boardEl.appendChild(btn); cells.push(btn);
  }
  updateHUD();
  startRoundTimer();
}

function startRoundTimer(){
  timeLeft = ROUND_TIME;
  updateTimer();
  if(roundTimer) clearInterval(roundTimer);
  roundTimer = setInterval(()=>{
    timeLeft -= 0.1;
    if(timeLeft <= 0){
      timeLeft = 0;
      updateTimer();
      clearInterval(roundTimer);
      if(!roundOver) timeoutRound();
    } else {
      updateTimer();
    }
  }, 100);
}

function updateTimer(){
  timerEl.textContent = timeLeft.toFixed(1);
  if(timeLeft <= 2) timerEl.style.color = '#f87171';
  else timerEl.style.color = '#e7ecf0';
}

function stopRoundTimer(){
  if(roundTimer) clearInterval(roundTimer);
  roundTimer = null;
}

function timeoutRound(){
  roundOver = true;
  stopRoundTimer();
  // Count who has more marks
  const xCount = board.filter(c => c === 'X').length;
  const oCount = board.filter(c => c === 'O').length;
  
  let winner = null;
  if(xCount > oCount) winner = 'X';
  else if(oCount > xCount) winner = 'O';
  
  if(winner){
    scores[winner]++;
    updateHUD();
  }
  
  setTimeout(()=>{
    if (scores.X===3 || scores.O===3){
      endMatch();
    } else {
      resetRound();
    }
  }, 1000);
}

function onCellClick(e){
  if (!paid){ addLine('<span class="warn">Please complete payment to play.</span>'); return; }
  const idx = Number(e.currentTarget.dataset.index);
  if (roundOver || board[idx]) return;
  makeMove(idx, turn);
  if (roundOver) return;
  if (turn==='O') setTimeout(()=>cpuMove(), 300);
}

function makeMove(idx, player){
  board[idx]=player;
  const mark=cells[idx].querySelector('.mark');
  mark.textContent=player; mark.className=`mark ${player.toLowerCase()}`;
  cells[idx].disabled = true;
  const res = getResult(board);
  if (res.winner){ endRound(res.winner, res.line); }
  else if (res.draw){ endRound(null, []); }
  else { turn = (player==='X' ? 'O' : 'X'); updateHUD(); }
}

function updateHUD(){
  turnBadge.textContent = turn;
  scoreXEl.textContent = String(scores.X);
  scoreOEl.textContent = String(scores.O);
}

function endRound(winner, line){
  roundOver = true;
  stopRoundTimer();
  if (winner){
    scores[winner]++;
    line.forEach(i => cells[i].classList.add('win'));
  }
  updateHUD();

  setTimeout(()=>{
    if (scores.X===3 || scores.O===3){
      endMatch();
    } else {
      resetRound();
    }
  }, 1000);
}

function resetRound(){
  board = Array(9).fill(''); 
  turn='X'; 
  roundOver=false;
  cells.forEach(c=>{
    c.classList.remove('win'); c.disabled=false;
    const m=c.querySelector('.mark'); m.textContent=''; m.className='mark';
  });
  updateHUD();
  startRoundTimer();
}

function resetMatch(){ 
  scores={X:0,O:0}; 
  resetRound(); 
}

function getResult(b){
  for (const L of WIN_LINES){
    const [a,bb,c] = L;
    if (b[a] && b[a]===b[bb] && b[a]===b[c]) return { winner:b[a], line:L };
  }
  if (b.every(v=>v)) return { draw:true, line:[] };
  return { winner:null, draw:false, line:[] };
}

function emptyIdx(b){ return b.map((v,i)=>v?null:i).filter(v=>v!==null); }
function minimax(b, player){
  const r=getResult(b);
  if (r.winner==='X') return { score:-10 };
  if (r.winner==='O') return { score:10 };
  if (r.draw) return { score:0 };
  const moves=[];
  for (const i of emptyIdx(b)){
    const nb=b.slice(); nb[i]=player;
    const next = player==='O' ? 'X' : 'O';
    const { score } = minimax(nb, next);
    moves.push({ index:i, score });
  }
  if (player==='O'){ let best=-Infinity, bm=moves[0]; for (const m of moves) if (m.score>best){ best=m.score; bm=m; } return bm; }
  else { let best=Infinity, bm=moves[0]; for (const m of moves) if (m.score<best){ best=m.score; bm=m; } return bm; }
}
function cpuMove(){
  if(roundOver) return;
  if (board.every(v=>!v) && board[4]===''){ makeMove(4,'O'); return; }
  const m = minimax(board.slice(),'O'); makeMove(m.index,'O');
}

/* ===== Start & Replay (Pay-Gated) ===== */
playBtn.addEventListener('click', (e)=>{
  e.preventDefault();
  payThen(()=>{
    document.getElementById('intro-overlay').classList.add('hidden');
    updatePaid(true);
    initBoard();
    resetMatch();
  }, playBtn);
});

resetRoundBtn.addEventListener('click', (e)=>{
  e.preventDefault();
  if (!paid) return;
  payThen(()=>{
    resetRound();
  }, resetRoundBtn);
});

resetMatchBtn.addEventListener('click', (e)=>{
  e.preventDefault();
  if (!paid) return;
  payThen(()=>{
    resetMatch();
  }, resetMatchBtn);
});

function endMatch(){
  const winner = scores.X===3 ? 'X' : 'O';
  const msg = document.createElement('div');
  msg.textContent = `Match over! Winner: ${winner}`;
  msg.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);font-size:42px;font-weight:900;color:#fbbf24;text-shadow:0 0 30px #fbbf24;pointer-events:none;z-index:1000;';
  document.body.appendChild(msg); 
  setTimeout(()=>msg.remove(),2500);
}

/* ===== Safety logs ===== */
window.addEventListener('error', e=>console.error('Error:', e.error||e));
window.addEventListener('unhandledrejection', e=>console.error('Unhandled promise:', e.reason));
</script>
</body>
</html>
